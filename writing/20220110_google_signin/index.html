<!DOCTYPE html><html><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Google Sign-In Integration" property="og:title"><title>Google Sign-In Integration</title><meta property="description"><link href="/favicon.ico" rel="icon" type="image/ico"><link href="/styles/styles.css" rel="stylesheet" type="text/css"></head><body><div class="nav"><h1 id="nicki-vanceindexhtml"><a href="/index.html">Nicki Vance</a></h1>
<ul>
  <li><a href="/index.html">Home</a></li>
  <li><a href="/writing/index.html">Writings</a></li>
</ul>
</div><div class="content-background"><div class="content-layout"><div class="postIntro"><h1 id="google-sign-in-integration">Google Sign-In Integration</h1>
</div><div class="date"><p>January 10, 2022</p>
</div><div class="postBody"><p>One of my larger work projects at in 2021 was to implement Google Sign-In authentication as a method for signup (account creation) and login. This is an overview of the existing architecture and the changes and decisions made. I’m curious if you’ll have suggestions for alternative approaches.</p>

<h2 id="the-setting">The Setting</h2>

<p>The business hypothesis was that signups would increase. But if you follow that logic through, the corollary is that people are giving up on signing up because they don't want to create a password. That feels unlikely?? Regardless, we thought it would be nice and make our application look more professional and trustworthy. And doesn't it, tho?</p>

<p>I was already familiar with the current architecture for signup (having implemented self-serve signup) but for this project I needed to get familiar with our existing authentication methods (password, API token, Guest token, SAML, and PKI), and authorizations.</p>

<h2 id="architecture">Architecture</h2>

<p>Note to the reader: The fact that I'm writing about this architecture does not necessarily mean it represents best practices. I'm open to comments and discussion. You may have or need a different architecture depending on your requirements.</p>

<h3 id="signup">Signup</h3>

<p>When a visitor signs up, they provide a name, email, and password. Users must have a unique email address.</p>

<p>The self-serve signup process creates an organization for the user as all user work must be associated with an organization.</p>

<p>To join an existing organization, there are two invitation methods:</p>

<ul>
  <li><strong>Email:</strong> An organization admin sends an invitation to the user's email. The user cannot change this email address. (Note: This is an important design decision and completely avoids a need to link existing accounts when an additional account is accidentally generated by the user.)</li>
  <li><strong>Invite URL:</strong> A potential user visits a unique signup URL that was created for the organization. The user must provide an email address which matches a configured host domain.</li>
</ul>

<p>To prevent bot signups, a hidden Google Recaptcha creates a token which includes Google's conclusion on whether the visitor is a bot. The token is added to the signup submission data and verified serverside.</p>

<p>Because a user's email address represents their identity, email verification is paramount and required before the user gains access to an account. Email invitees don't need to have a verification email sent to them because they have already proven email ownership by following the invitation link emailed to them.</p>

<h3 id="login">Login</h3>

<p>To log in, a user must provide the correct email and password combination. The login page posts the email and password to the session creation endpoint which authenticates the data and, if valid, fetches the user's API token and additional account information. This information is encoded and stored in a session cookie.</p>

<p>The authentication step, in addition to verifying identity, returns the user's authorization, a definition of their access privileges such as <code>member</code>, <code>owner</code>, <code>admin</code>, or, in the case of guests, <code>read_only</code>.</p>

<h3 id="information-privacy-measures">Information privacy measures</h3>

<p>To avoid leaking information about whether an email address is already associated with an account, the signup process shows everyone the same success message to check for a verification email. In fact, a user who has an existing account will receive a different email letting them know that they tried to signup and already have an account.</p>

<p>Similarly, when a visitor attempts to login, the same failure message is shown to everyone regardless of whether or not the email address is associated with an account.</p>

<h2 id="integration">Integration</h2>

<p>Since I'd never worked on authentication before, I was really starting with some basic questions. How do we know someone is who they say they are? Who can we trust?</p>

<p>With Google Sign-In, the client application is asking Google to authenticate the user. Does this user have an account with Google? Are they currently authenticated with Google? If not, we're happy to wait while they authenticate with Google right now.</p>

<h3 id="how-it-works">How it works</h3>

<p>The clientside application must initialize the Google Sign-In JS with our organization's client ID. This script can be used to generate a "Sign in with Google" button that can be placed where desired.</p>

<p>When the user clicks on the "Sign in with Google" button, a new browser window opens where the user is asked to select a Google account that they are already logged into or allowed to log into a different account. Once they have selected and authenticated an account, they are shown a consent screen declaring the content that Google will share with your organization (in this case, just profile info like name and email).</p>

<p>When the user confirms, the window is closed and the clientside Google Sign-In script executes a callback with a JSON Web Token (JWT) as an argument. The JWT may be decoded (there are third-party libraries for decoding) to access data about the user.</p>

<p>The JWT should be sent, still encoded, to your server to complete the account creation. A serverside Google Sign-In library is very useful to decode and verify the JWT.</p>

<p>The process is the same for login. There are options in the clientside JS to select the label and styles of the Google Sign-In button.</p>

<h2 id="next-time">Next Time</h2>

<p>What would I do differently next time?</p>

<p>Well, I didn't give alternatives a serious thought. auth0, okta? Would these be easier? If you have an opinion, I'd love to hear it. I liked working with the source, Google itself, rather than an intermediary, to learn about Google Sign-In.</p>

<p>I knew I didn't care about adding other signup methods, like Facebook or Github, which would be the advantage of these other solutions.</p>

<p>I also didn't need to look into handling Google authorizations beyond user profile information. Connecting a user's Google Calendar or Google Docs data is an additional set of concerns.</p>

<h2 id="ps-dear-product-team">PS: Dear Product Team</h2>

<p>One of the improvements I think could be made to Google Sign-In, as a user, would be some indication of which account I had signed in with before, if at all.</p>

<p>I'm usually authenticated in 3 different Google accounts at a time and I have many more.</p>

<p>When asked to authenticate with Google, I forget which Google account I used to login and accidentally create a new account (depending on the implementation of said app).</p>

<p>This is the main reason I don't use Google Sign-In unless required. I don't like accidentally creating multiple accounts. What's an extra account? It's not like the stack of loyalty coffee cards that stretch out my wallet which in turn wears a hole in my jean pocket.</p>

<p>To deal with this, this little pet peeve, I create 1Password logins for sites even when I use Google Sign-In so that I can leave a note to myself about which Google account I used. Dear 1Password product team…</p>

<h2 id="resources">Resources</h2>

<ul>
  <li>If you're doing a Google Sign-In integration, start with <a href="https://developers.google.com/identity/gsi/web/guides/overview">the official docs</a>.</li>
  <li><a href="https://cloud.google.com/nodejs/docs/reference/google-auth-library/latest">Documentation: Google Auth Library: Node.js Client</a></li>
  <li>
    <p>Example JWT</p>

    <p>Here's an <a href="https://developers.google.com/identity/gsi/web/reference/js-reference#CredentialResponse">example JWT</a> from the docs:</p>

    <div class="language-js highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">// header</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>{
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>alg</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">RS256</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>kid</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">f05415b13acb9590f70df862765c655f5a7a019e</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// JWT signature</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>typ</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">JWT</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>}
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="color:#777">// payload</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>{
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>iss</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[https://accounts.google.com](https://accounts.google.com/)</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// The JWT's issuer</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>nbf</span><span style="color:#404">&quot;</span></span>:  <span style="color:#00D">161803398874</span>,
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>aud</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[314159265-pi.apps.googleusercontent.com](http://314159265-pi.apps.googleusercontent.com/)</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// Your server's client ID</span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>sub</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">3141592653589793238</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// The unique ID of the user's Google Account</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>hd</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[gmail.com](http://gmail.com/)</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// If present, the host domain of the user's GSuite email address</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>email</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[elisa.g.beckett@gmail.com](mailto:elisa.g.beckett@gmail.com)</span><span style="color:#710">&quot;</span></span>, <span style="color:#777">// The user's email address</span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>email_verified</span><span style="color:#404">&quot;</span></span>: <span style="color:#069">true</span>, <span style="color:#777">// true, if Google has verified the email address</span>
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>azp</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[314159265-pi.apps.googleusercontent.com](http://314159265-pi.apps.googleusercontent.com/)</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>name</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Elisa Beckett</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>  <span style="color:#777">// If present, a URL to user's profile picture</span>
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>picture</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">[https://lh3.googleusercontent.com/a-/e2718281828459045235360uler](https://lh3.googleusercontent.com/a-/e2718281828459045235360uler)</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>given_name</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Elisa</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>family_name</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Beckett</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>iat</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1596474000</span>, <span style="color:#777">// Unix timestamp of the assertion's creation time</span>
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>exp</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1596477600</span>, <span style="color:#777">// Unix timestamp of the assertion's expiration time</span>
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>jti</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">abc161803398874def</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span>}
</pre></div>
</div>
    </div>
  </li>
</ul>
</div></div></div><div class="footer"><div class="nav"><ul>
  <li><a href="/index.html">Home</a></li>
  <li><a href="/writing/index.html">Writings</a></li>
</ul>
</div><p>Want occasional updates sent to your inbox? Join the <a href="https://tinyletter.com/nickivance">mailing list</a>.</p>

<p>Email me at: <a href="mailto:nicki@boxingindustries.com">nicki@boxingindustries.com</a></p>

<p>I'm also on Twitter: <a href="https://twitter.com/wootbeep">@wootbeep</a>.</p>
</div></body></html><footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-90558965-3', 'auto');
ga('send', 'pageview');</script></footer>